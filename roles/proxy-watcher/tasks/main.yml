# roles/proxy_watcher/tasks/main.yml

- name: Ensure config directory exists
  file:
    path: "{{ proxy_watcher_config_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy proxy-watcher config
  template:
    src: "config.yaml.j2"
    dest: "{{ proxy_watcher_config_path }}"
    owner: root
    group: root
    mode: "0644"
  notify: Restart proxy-watcher

- name: Create log directory for proxy-watcher
  file:
    path: /var/log/proxy-watcher
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Ensure proxy-watcher workdir exists
  file:
    path: /opt/proxy-watcher
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy proxy-watcher config
  template:
    src: config.yaml.j2
    dest: /etc/proxy-watcher/config.yaml
    owner: root
    group: root
    mode: "0640"
  notify: Restart proxy-watcher

- name: Install systemd unit
  template:
    src: "proxy-watcher.service.j2"
    dest: "/etc/systemd/system/proxy-watcher.service"
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart proxy-watcher

- name: Ensure proxy-watcher service is enabled
  systemd:
    name: proxy-watcher
    enabled: yes
    state: started